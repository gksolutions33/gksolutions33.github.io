<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Market Updates — GK Solutions</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b1020;--muted:#9aa4c0;--card:#071026}
    body{font-family:'Inter',sans-serif;margin:0;background:var(--bg);color:#e6eef8;min-height:100vh}
    header{padding:20px;text-align:center;background:linear-gradient(90deg,#071021,#07162b)}
    header h1{margin:0;font-size:1.6rem}
    nav{display:flex;justify-content:center;gap:12px;margin-top:8px}
    nav a{color:var(--muted);text-decoration:none}
    main{max-width:1100px;margin:20px auto;padding:0 16px;display:flex;gap:20px}
    .list{width:380px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03)}
    .card h3{margin:0 0 6px 0;font-size:1rem}
    .card p{margin:0;color:var(--muted);font-size:0.9rem}
    .btn{display:inline-block;margin-top:8px;padding:8px 10px;border-radius:8px;background:#00f5ff;color:#001;font-weight:700;text-decoration:none}
    .viewer{flex:1;min-height:60vh;background:#061026;padding:18px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);overflow:auto}
    .meta{color:var(--muted);font-size:0.85rem;margin-bottom:8px}
    .small{font-size:0.85rem;color:var(--muted)}
    .subscribe{margin:12px 0;padding:12px;background:#081426;border-radius:8px}
    .search{margin-bottom:12px}
    input[type="search"]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#e6eef8}
  </style>
</head>
<body>
  <header>
    <h1>Market Updates</h1>
    <div class="small">Auto-posted crypto & stock summaries — updated daily</div>
    <nav>
      <a href="index.html">Home</a>
      <a href="projects.html">Projects</a>
      <a href="tutorials.html">Tutorials</a>
      <a href="contact.html">Contact</a>
    </nav>
  </header>

  <main>
    <aside class="list">
      <div class="subscribe">
        <strong>Subscribe</strong>
        <p class="small">Get daily market updates by email (coming soon). For now, bookmark this page.</p>
      </div>

      <div class="search">
        <input id="q" type="search" placeholder="Search posts (title or date)" />
      </div>

      <div id="posts-list" aria-live="polite">
        <!-- filled by JS -->
      </div>
    </aside>

    <section class="viewer" id="viewer">
      <div id="viewer-content">
        <h2 style="margin-top:0">Open a post to view it here</h2>
        <p class="small">Click any item on the left to load the full post inside this box.</p>
      </div>
    </section>
  </main>

<script>
const POSTS_JSON = '/posts.json'; // updated by generator
let posts = [];

async function loadIndex(){
  try {
    const r = await fetch(POSTS_JSON + '?_=' + Date.now());
    if(!r.ok) throw new Error('No posts index');
    posts = await r.json();
    renderList(posts);
  } catch(err){
    document.getElementById('posts-list').innerHTML = '<div class="card"><p class="small">No market posts found yet. The bot will publish daily.</p></div>';
    console.error(err);
  }
}

function renderList(list){
  const el = document.getElementById('posts-list');
  if(!list || list.length===0){
    el.innerHTML = '<div class="card"><p class="small">No posts yet.</p></div>';
    return;
  }
  el.innerHTML = '';
  list.forEach((p, idx) => {
    const d = new Date(p.date);
    const html = `
      <div class="card">
        <h3>${escapeHtml(p.title)}</h3>
        <div class="meta">${d.toLocaleString()}</div>
        <p>${escapeHtml(p.excerpt)}</p>
        <a href="#" data-url="${p.permalink}" data-index="${idx}" class="btn open">Read</a>
      </div>`;
    el.insertAdjacentHTML('beforeend', html);
  });

  // attach click handlers
  document.querySelectorAll('.open').forEach(a=>{
    a.addEventListener('click', function(ev){
      ev.preventDefault();
      const url = this.dataset.url;
      loadPost(url);
    });
  });
}

async function loadPost(permalink){
  // permalink is like /2025/11/30/slug.html
  try {
    const fullUrl = permalink.startsWith('/') ? permalink : '/' + permalink;
    const r = await fetch(fullUrl);
    if(!r.ok){
      document.getElementById('viewer-content').innerHTML = '<p class="small">Post not found (build might be pending).</p>';
      return;
    }
    const html = await r.text();

    // sanitize a bit: display only article contents between <article>..</article> if using our Jekyll layout
    const temp = document.createElement('div');
    temp.innerHTML = html;

    // prefer article tag if present
    let article = temp.querySelector('article');
    let content = article ? article.innerHTML : temp.innerHTML;

    // make all links open in same site (or new tab for external)
    const doc = document.createElement('div');
    doc.innerHTML = content;
    doc.querySelectorAll('a').forEach(a=>{
      // if external link - open in new tab, else open in same window (keeps user on site)
      const href = a.getAttribute('href') || '';
      if(href.startsWith('http') && !href.includes(location.hostname)){
        a.setAttribute('target','_blank');
        a.setAttribute('rel','noopener noreferrer');
      } else {
        // internal link: keep same domain — leave default so user stays on site
        a.removeAttribute('target');
      }
    });

    // Inject processed content into viewer
    document.getElementById('viewer-content').innerHTML = doc.innerHTML;

    // Scroll viewer to top
    document.getElementById('viewer').scrollTop = 0;

    // Optionally: add "Read next" links at bottom using posts.json
    addReadNext(permalink);

  } catch(err){
    console.error(err);
    document.getElementById('viewer-content').innerHTML = '<p class="small">Error loading post.</p>';
  }
}

function addReadNext(currentPermalink){
  const idx = posts.findIndex(p => p.permalink === currentPermalink || p.url === currentPermalink);
  const container = document.getElementById('viewer-content');
  const next = posts[idx+1] || posts[0];
  if(!next) return;
  const html = `<hr><div class="small">Read next: <a href="${next.permalink}">${escapeHtml(next.title)}</a></div>`;
  container.insertAdjacentHTML('beforeend', html);
}

// quick search filter
document.getElementById('q').addEventListener('input', function(){
  const q = this.value.toLowerCase().trim();
  if(!q) return renderList(posts);
  const filtered = posts.filter(p => (p.title + ' ' + p.excerpt + ' ' + p.date).toLowerCase().includes(q));
  renderList(filtered);
});

function escapeHtml(s){
  if(!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

loadIndex();
</script>
</body>
</html>
